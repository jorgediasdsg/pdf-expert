# ADR-004 â€” Improve HTTP handler and JSON response structure

## Status

Accepted

## Context

In Phase 1, the HTTP handler:

- used `http.Error` with plain text messages,
- returned different formats depending on the code path,
- mixed error handling and main logic in a single function.

This makes it:

- harder for clients to parse errors consistently,
- harder to add new endpoints with a standard pattern,
- more difficult to read and maintain the handler code.

We want clients and developers to have **predictable response shapes**.

## Decision

We will:

1. Introduce simple JSON response helpers in `internal/httpapi`, such as:
   - `writeJSON(w http.ResponseWriter, status int, data any)`
   - `writeError(w http.ResponseWriter, status int, message string)`

2. Update the `/analyze` handler to:
   - use a consistent JSON error format, for example:
     ```json
     {
       "error": "Failed to read file"
     }
     ```
   - keep the success response format stable:
     ```json
     {
       "file": "example.pdf",
       "word_count": 1234,
       "status": "completed"
     }
     ```

3. Keep handler functions **shorter and focused**:
   - input validation,
   - delegation to analyzer,
   - output formatting.

## Consequences

### Positive

- Clients get consistent JSON responses (success and error).
- Handlers become easier to read and modify.
- New endpoints can reuse helper functions and patterns.
- This sets a foundation for global error handling or middleware in later phases.

### Negative

- Slightly more abstraction around HTTP responses.
- Some duplication may remain until we introduce a more structured error model in Phase 3.

## Alternatives considered

1. **Keep using `http.Error` and ad-hoc JSON**  
   - Rejected: inconsistent responses and harder client integration.

2. **Introduce a full error-handling middleware layer now**  
   - Rejected for this phase: we prefer incremental changes and will consider a more advanced middleware approach in Phase 3.

---
